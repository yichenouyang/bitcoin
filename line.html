<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>

	<script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
  *{
    margin:0;
    padding:0;
  }

  body{
     height: 100%;
     padding: 0;
     scroll-behavior: smooth;
     background: gray;
     color:white;
     font-family: 'Open Sans', sans-serif;
     font-weight: 100;
  }
  h2{
    line-height: 1.25;
    padding-top: 45px;
    font-weight: 300;
  }
  strong{
    font-weight: 600;
  }
  #main {
    max-width:  1440px;
    width: 100%;
    position:relative; 
    height:  100%;
    margin:auto;
  }
  .text {
    height: 100%;
    max-width: 440px;
    width: 100%;
    margin: 0;
    padding: 0;
    position: absolute;
    height: 100%;
    line-height: 1.5;
    left: 00px;
  }
  .text div {
	topï¼š50px;
    height: 500px;
    display: block;
    padding: 0 15px;
  }
  .marker {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
    }
  .line {
    position: relative;
    height: 1500px;
    top: 0px;
  }
    </style>
  </head>

  <body>
	  <div id="main">
  		<div class="text">
    	<div id="div1">
      	<h2>On <strong>July 27, 2017</strong> there were <strong>20</strong> people attending the Data Visualization meetup.</h2>
		</div>
    	<div id="div2">
      <h2>Out of those <strong>20</strong> there were <strong>12</strong> people who attended.</h2>
      <p></p>
    </div>
    	<div id="div4">
      	<h2><strong>5</strong> out of <strong>12</strong> people had iphones. The other <strong>7</strong> had android devices</h2>
    	</div>
    	<div id="div6">
      	<h2>Out of those <strong>12</strong> attendees only <strong>3</strong> people were San Diego natives. <br><br>The age group for the attendees ranged between 25 and 65.</h2>
    	</div>
  		</div>
  	<div class="line">
    	<svg width="1000" height="5000"></svg>
  	</div>
    <div class="marker"></div>

	 </div>
<script>
    
	function prepareData(price) {
      
        let xScale = d3.scaleSqrt()
            .range([0, 600])
            .domain([750,20000])
		
		
		let newdata ={categoryX: 300, points: []}			
			price.map((d)=>{
				newdata.points.push({
				x:100+xScale(d.price),
				y:150+20*d.id,
				t:d.time,
			})
			})
		return newdata 
    }
	
	d3.csv("price.csv").then((price)=>{
		data = prepareData(price)
		console.log(data)

    var svg = d3.select('svg');
    var distancePath = svg.append('path')
      .attr('fill', 'none')
      .attr('stroke', 'none').node();

    var source;
    var target;
    var gap = 100;
    var totalDistance = 0;
    _.each(data.points, function(target) {
      if (!source) {
        target.d = 'M' + target.x + ',' + target.y;
      } else {
        if (source.y > target.y - gap) {
          // if they're sufficiently close to each other
          if (source.x === target.x) {
            target.d = drawLine(target.x, target.y);
            setDistance(source, target);
          } else {
            target.d = drawCurve(source.x, source.y, target.x, target.y);

            setDistance(source, target);
            target.y1 = target.y - source.y;
            target.interpolate1 = d3.interpolate(0, target.distance);
          }
        } else {
          target.d = '';
          if (source.x !== data.categoryX) {
            // if the source repo owner isn't the same as the contributor, move the line back
            target.d += drawCurve(source.x, source.y, data.categoryX, source.y + gap / 3);

            setDistance(source, target);
            target.y1 = gap / 3;
            target.interpolate1 = d3.interpolate(0, target.distance);
          }

          x = target.x;
          y = target.y;
          if (target.x !== data.categoryX) {
            x = data.categoryX;
            y = target.y - gap / 3;
          }
          
          target.d += drawLine(x, y);
          target.y2 = y - (target.y1 || 0);
          setDistance(source, target);

          if (target.x !== data.categoryX) {
            target.d += drawCurve(x, y, target.x, target.y);
            var currentDistance = target.distance;
            setDistance(source, target);
            target.y3 = gap / 3;
            target.interpolate2 = d3.interpolate(0, target.distance - currentDistance);
          }
        }
        target.totalDistance = (totalDistance += target.distance);
        
      }
      source = target;
    });

    var path = svg.append('path')
      .attr('d', _.pluck(data.points, 'd').join(' '))
      .attr('fill-opacity', 0)
      .attr('stroke', '#3FB8AF')
      .attr('stroke-width', 4)
      .attr('stroke-linecap', 'round')
      .attr('stroke-dasharray', totalDistance)
      .attr('stroke-dashoffset', totalDistance);
    var circle = svg.selectAll('circle')
      .data(data.points).enter().append('circle')
      .attr('fill', '#fff')
      .attr('stroke', '#3FB8AF')
      .attr('stroke-width', 2)
      .attr('cx', function(d) {return d.x})
      .attr('cy', function(d) {return d.y})
      .attr('r', 4);

    window.addEventListener('scroll', _.throttle(windowScroll, 200));

    function windowScroll() {
      var top = scrollY + 400;
      var source;
      var target = _.find(data.points, function(point) {
        if (point.y >= top) {
          return true;
        }
        source = point;
        return false;
      });
      if (source && target) {
        var distance = 0;
        var distanceFromSource = top - source.y;
        if (!target.interpolate1) {
          // if there's no interpolate1
          if (!target.interpolate2) {
            // and there's no interpolate2, must mean it's a straight line
            distance = distanceFromSource + source.totalDistance;
          } else {
            // if there's a interpolate2, must mean there's a straight line
            // and then a curve at the end, so figure out if we're in straight line or curve part
            if (distanceFromSource <= target.y2) {
              // it's in straight line part
              distance = distanceFromSource + source.totalDistance;
            } else {
              // if it's in last curve part, first interpolate the curve
              // and then add that back to the straight part and the previous total distance
              var partialDistance = (distanceFromSource - target.y2) / target.y3;
              distance = target.interpolate2(partialDistance) + target.y2 + source.totalDistance;
            }
          }
        } else {
          // if there's interpolate1, must mean there's a first curve
          if (distanceFromSource <= target.y1) {
            // so if it's within the first curve, interpolate that and add it to total distance
            var partialDistance = distanceFromSource / target.y1;
            distance = target.interpolate1(partialDistance) + source.totalDistance;
          } else if (distanceFromSource <= (target.y1 + target.y2)) {
            // if we're in line part, add curve to it
            distance = target.interpolate1(1) + (distanceFromSource - target.y1) + source.totalDistance;
          } else if (interpolate2) {
            var partialDistance = (distanceFromSource - target.y2 - target.y1) / target.y3;
            distance = target.interpolate1(1) + target.y2 + target.interpolate2(partialDistance);
          }
        }
        // var partialDistance = (top - source.y) / (target.y - source.y);
        // var distance = target.interpolater(partialDistance) + source.totalDistance;
        path.transition().duration(200)
          .attr('stroke-dashoffset', totalDistance - (distance || 0));
      }
      
    };

    function drawLine(x, y) {
      return 'L' + x + ',' + y;
    }

    function drawCurve(x1, y1, x2, y2) {
      var cy = (y1 + y2) / 2;
      return 'C' + x1 + ',' + cy + ' ' + x2 + ',' + cy + ' ' + x2 + ',' + y2;
    }

    function setDistance(source, target) {
      var distancePathD = 'M' + source.x + ',' + source.y + ' ' + target.d;
      distancePath.setAttribute('d', distancePathD);
      target.distance = parseFloat(distancePath.getTotalLength().toFixed(2));
    }
})
    </script>
  </body>
</html>